<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Teacher Dashboard</title>
  <style>
    body { background:#111; color:#eee; font-family:sans-serif; margin:0; display:flex; }
    #sidebar { width:220px; background:#222; padding:1rem; }
    #main { flex:1; padding:1rem; }
    #className { font-size:0.85rem; padding:0.35rem; max-width:100%; }
    #totalsRow { display:flex; justify-content:space-between; align-items:center; margin-bottom:0.5rem; }
    #currentClassName { font-size:1.1rem; font-weight:600; margin-left:1rem; }
    .student-card { background:#1a1a1a; border:1px solid #333; border-radius:6px; padding:0.5rem; margin:0.5rem; width:150px; display:inline-block; vertical-align:top; }
    .student-card-header { display:flex; justify-content:space-between; align-items:center; padding-right:0.3rem; }
    .student-card-header .name {
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  flex: 1 1 auto;
  margin-right: 0.5rem;
}
    .more-btn { background:none; border:none; color:#aaa; cursor:pointer; }
    .add-btn { width:100%; margin-top:0.5rem; }
  </style>
</head>
<body>
  <div id="sidebar">
    <div id="authStatus">Signed out</div>
    <button id="btnSignIn">Sign in with Google</button>
    <button id="btnSignOut" disabled>Sign out</button>
    <hr>
    <label>Select Class:</label>
    <select id="className"><option disabled selected>— Select —</option></select>
    <button id="btnResetDaily">Reset Daily</button>
    <button id="btnResetTotal">Reset Total</button>
    <button id="btnAddAll">+1 to All</button>
  </div>
  <div id="main">
    <div id="totalsRow">
      <div>
        <div id="todayPoints">Today's Points: 0</div>
        <div id="totalPoints">Total Points: 0</div>
      </div>
      <div id="currentClassName"></div>
    </div>
    <div id="students"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, collection, query, getDocs, onSnapshot, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const app = initializeApp({
      apiKey:"AIzaSyDNNuSuHAqpms8UvOTCDmrEnXN648eTkxo",
      authDomain:"classroompoints.firebaseapp.com",
      projectId:"classroompoints",
      storageBucket:"classroompoints.firebasestorage.app",
      messagingSenderId:"176805498618",
      appId:"1:176805498618:web:2071d90825bafb78154343",
      measurementId:"G-BLJYG5JYQW"
    });

    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    function isSignedIn(){ return !!auth.currentUser; }
    function updateAuthUI(user){
      const s = document.getElementById("authStatus");
      const inBtn = document.getElementById("btnSignIn");
      const outBtn = document.getElementById("btnSignOut");
      if (user){ s.textContent = `Signed in as ${user.displayName || user.email || "User"}`; inBtn.disabled = true; outBtn.disabled = false; }
      else { s.textContent = "Signed out"; inBtn.disabled = false; outBtn.disabled = true; }
    }
    onAuthStateChanged(auth, (u)=>{ updateAuthUI(u); if (u) { populateClassDropdown(); }});

    document.getElementById("btnSignIn").addEventListener("click", async ()=>{
      try { await signInWithPopup(auth, provider); } catch(e){ console.error(e); }
    });
    document.getElementById("btnSignOut").addEventListener("click", async ()=>{
      try { await signOut(auth); } catch(e){ console.error(e); }
    });

    async function populateClassDropdown(){
      if (!isSignedIn()) return;
      const sel = document.getElementById("className");
      sel.innerHTML = '<option disabled selected>— Select —</option>';
      const snap = await getDocs(collection(db, "classes"));
      snap.forEach(d => {
        const data = d.data() || {};
        const opt = document.createElement("option");
        opt.value = d.id;
        opt.textContent = data.displayName || d.id;
        sel.appendChild(opt);
      });
    }

    let unsubscribe = null;
    let unsubMeta = null;
    document.getElementById("className").addEventListener("change", (e)=>{
      const id = e.target.value;
      if (!id || !isSignedIn()) return;
      if (unsubscribe) unsubscribe();
      if (unsubMeta) unsubMeta();
      unsubMeta = onSnapshot(doc(db, \"classes\", id), (snap)=>{
        const data = snap.data() || {};
        document.getElementById(\"currentClassName\").textContent = data.displayName || id;
      });
      unsubscribe = onSnapshot(collection(db, \"classes\", id, \"students\"), (snap)=>{
        const container = document.getElementById("students");
        container.innerHTML = "";
        snap.forEach(d=>{
          const s = d.data();
          const card = document.createElement("div");
          card.className = "student-card";
          card.innerHTML = `
            <div class=\"student-card-header\">\n              <span class=\"name\" title=\"${s.name || d.id}\">${s.name || d.id}</span>\n              <button class=\"more-btn\" aria-label=\"More options\">⋮</button>\n            </div>
            <div class="points">Daily: ${s.points?.daily||0}<br>Total: ${s.points?.total||0}</div>
            <button class="add-btn">+1</button>
          `;
          container.appendChild(card);
        });
        document.getElementById("currentClassName").textContent = id;
      });
    });
  </script>
</body>
</html>
