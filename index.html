<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Classroom Points Tracker</title>
  <style>
    /* Base */
    html, body { margin: 0; padding: 0; height: 100%; background: #121212; color: #FFF; font-family: sans-serif; overflow-y: auto; }
    /* Sidebar */
    #sidebar { position: fixed; top: 0; left: 0; width: 200px; height: 100%; background: #1E1E1E; border-right: 1px solid #333; padding: 1rem; box-sizing: border-box; transition: left 0.3s ease; z-index: 100; }
    #sidebar.collapsed { left: -200px; }
    #sidebarToggle { position: absolute; top: 1rem; right: -20px; width: 20px; height: 60px; background: #1E1E1E; border: 1px solid #333; border-left: none; border-radius: 0 4px 4px 0; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; user-select: none; z-index: 101; }
    /* Main content */
    .content { margin-left: 200px; padding: 2em; transition: margin-left 0.3s ease; }
    .content.collapsed { margin-left: 0; }
    /* Stats headings */
    #stats { margin-bottom: 1rem; }
    #stats h2 { margin: 0.2rem 0; font-size: 1.2rem; }
    /* Controls */
    .controls label, .controls select, .controls button { display: block; width: 100%; margin: 0.5rem 0; box-sizing: border-box; }
    select, button { font-size: 1em; padding: 0.5em 1em; background: #2A2A2A; color: #FFF; border: 1px solid #333; border-radius: 4px; cursor: pointer; text-align: left; }
    select:hover, button:hover { background: #3A3A3A; }
    /* Student grid */
    #studentsContainer { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 0.75rem; }
    .student-card { position: relative; background: #1E1E1E; border: 1px solid #333; border-radius: 6px; padding: 0.75rem; box-sizing: border-box; }
    .student-card h3 { margin: 0.5rem 0 0.25rem; font-size: 1rem; }
    .student-card p { margin: 0.25rem 0; font-size: 0.9rem; }
    .add-button { width: 100%; font-size: 0.8rem; padding: 0.3rem 0.5rem; margin: 0.2rem 0; background: #2A2A2A; color: #FFF; border: 1px solid #333; border-radius: 4px; cursor: pointer; }
    .add-button:hover { background: #3A3A3A; }
    .menu-button { position: absolute; top: 0.5rem; right: 0.5rem; background: transparent; border: none; color: #FFF; font-size: 1.2rem; cursor: pointer; z-index: 200; }
    .menu { display: none; position: absolute; top: 2rem; right: 0.5rem; background: #2A2A2A; border: 1px solid #333; border-radius: 4px; padding: 0.5rem; z-index: 200; }
    .student-card.expanded .menu { display: block; }
    .menu button { width: 100%; font-size: 0.75rem; padding: 0.3rem; margin: 0.25rem 0; background: #3A3A3A; color: #FFF; border: none; border-radius: 4px; cursor: pointer; text-align: left; }
    .menu button:hover { background: #4A4A4A; }
    /* Toast notifications */
    #toast-container { position: fixed; top: 1rem; right: 1rem; z-index: 300; }
    .toast { min-width: 220px; margin-bottom: 0.5rem; padding: 0.75rem 1rem; border-radius: 0.25rem; background: rgba(30,30,30,0.9); color: #FFF; display: flex; justify-content: space-between; align-items: center; }
    .toast button { background: transparent; border: none; color: #0af; cursor: pointer; margin-left: 1rem; }
  </style>
</head>
<body>
  <div id="sidebar">
    <button id="sidebarToggle">‚Äπ</button>
    <div class="controls">
      <div id="authStatus" style="margin-bottom:0.5rem;font-size:0.9rem;opacity:0.85">Signed out</div>
      <button id="btnSignIn">Sign in with Google</button>
      <button id="btnSignOut" disabled>Sign out</button>
      <hr style="border:none;border-top:1px solid #333;margin:0.75rem 0" />
      <label for="classDropdown">Select Class:</label>
      <select id="classDropdown"></select>
      <button onclick="resetDailyPoints()">üîÅ Reset Daily</button>
      <button onclick="resetTotalPoints()">üßπ Reset Total</button>
      <button onclick="addDailyPointToAll()">+1 to All</button>
    </div>
  </div>
  <div class="content">
    <div id="stats">
      <h2>Today's Points: <span id="sumDaily">0</span></h2>
      <h2>Total Points: <span id="sumTotal">0</span></h2>
    </div>
    <div id="studentsContainer"></div>
  </div>
  <div id="toast-container" aria-live="polite" aria-atomic="true"></div>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, query, getDocs, onSnapshot, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    // Firebase init
    if (location.protocol === "file:") console.warn("Firebase Auth may not work on file://. Serve over http:// or https://");
    const app = initializeApp({ apiKey: "AIzaSyB17jY--gDsic8lCJ-jun1BdLFW_vz-tBI", authDomain: "classroompoints.firebaseapp.com", projectId: "classroompoints", storageBucket: "classroompoints.firebasestorage.app", messagingSenderId: "176805498618", appId: "1:176805498618:web:2071d90825bafb78154343", measurementId: "G-BLJYG5JYQW" });
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();
    function isSignedIn(){ return !!auth.currentUser; }
    function updateAuthUI(user){
      const s = document.getElementById("authStatus");
      const inBtn = document.getElementById("btnSignIn");
      const outBtn = document.getElementById("btnSignOut");
      if (user){ s.textContent = `Signed in as ${user.displayName || user.email || "User"}`; inBtn.disabled = true; outBtn.disabled = false; }
      else { s.textContent = "Signed out"; inBtn.disabled = false; outBtn.disabled = true; }
    }
    onAuthStateChanged(auth, (u)=>{ updateAuthUI(u); if (u) { populateClassDropdown(); } });
    let currentClass = null, unsubscribeStudents = null;
    const sidebar = document.getElementById('sidebar'), content = document.querySelector('.content'), toggleBtn = document.getElementById('sidebarToggle');
    let isCollapsed = false;
    toggleBtn.addEventListener('click', () => {
      isCollapsed = !isCollapsed;
      sidebar.classList.toggle('collapsed', isCollapsed);
      content.classList.toggle('collapsed', isCollapsed);
      toggleBtn.textContent = isCollapsed ? '‚Ä∫' : '‚Äπ';
    });
    document.getElementById("btnSignIn").addEventListener("click", async () => {
      try { await signInWithPopup(auth, provider); showToast("Signed in."); } catch(e){ console.error(e); showToast("Sign-in failed.", "Retry", ()=>document.getElementById("btnSignIn").click()); }
    });
    document.getElementById("btnSignOut").addEventListener("click", async () => {
      try { await signOut(auth); showToast("Signed out."); } catch(e){ console.error(e); showToast("Sign-out failed."); }
    });

    function showToast(msg, actionText, actionFn, duration = 5000) {
      const c = document.getElementById('toast-container'); const t = document.createElement('div'); t.className = 'toast';
      t.innerHTML = `<span>${msg}</span>${actionText ? `<button>${actionText}</button>` : ''}`;
      if (actionText && actionFn) t.querySelector('button').addEventListener('click', () => { actionFn(); c.removeChild(t); });
      c.appendChild(t); setTimeout(() => c.contains(t) && c.removeChild(t), duration);
    }
    async function populateClassDropdown() {
      if (!isSignedIn()) { showToast("Sign in to load classes."); return; }
      const dd = document.getElementById('classDropdown'); dd.innerHTML = '';
      try { const snap = await getDocs(collection(db, 'classes'));
        snap.forEach(ds => { const o = document.createElement('option'); o.value = ds.id; o.text = ds.id; dd.appendChild(o); });
        if (snap.docs.length) { loadClass(dd.value = snap.docs[0].id); }
        dd.addEventListener('change', () => loadClass(dd.value));
      } catch (e) { console.error(e); showToast('Couldn\'t load classes.', 'Retry', populateClassDropdown); }
    }
    async function loadClass(cn) {
      if (unsubscribeStudents) unsubscribeStudents(); currentClass = cn;
      unsubscribeStudents = onSnapshot(query(collection(db, 'classes', cn, 'students')),
        snap => renderStudentCards(snap.docs.map(d => ({ id: d.id, data: d.data() }))),
        e => { console.error(e); showToast('Couldn\'t load students.', 'Retry', () => loadClass(cn)); }
      );
    }
    function updateStats(students) {
      const sumDaily = students.reduce((acc, { data }) => acc + (data.points?.daily || 0), 0);
      const sumTotal = students.reduce((acc, { data }) => acc + (data.points?.total || 0), 0);
      document.getElementById('sumDaily').textContent = sumDaily;
      document.getElementById('sumTotal').textContent = sumTotal;
    }
    function toggleMenu(id) { document.getElementById(`student-card-${id}`).classList.toggle('expanded'); }
    function renderStudentCards(students) {
      const ctr = document.getElementById('studentsContainer'); ctr.innerHTML = '';
      students.forEach(({ id, data }) => {
        const c = document.createElement('div'); c.className = 'student-card'; c.id = `student-card-${id}`;
        const mb = document.createElement('button'); mb.className = 'menu-button'; mb.textContent = '‚ãÆ'; mb.addEventListener('click', () => toggleMenu(id)); c.appendChild(mb);
        const nameEl = document.createElement('h3'); nameEl.textContent = data.name || id; c.appendChild(nameEl);
        const dEl = document.createElement('p'); dEl.textContent = `Daily: ${data.points?.daily || 0}`; c.appendChild(dEl);
        const tEl = document.createElement('p'); tEl.textContent = `Total: ${data.points?.total || 0}`; c.appendChild(tEl);
        const ab = document.createElement('button'); ab.className = 'add-button'; ab.textContent = '+1'; ab.addEventListener('click', () => addPoint(currentClass, id)); c.appendChild(ab);
        const menu = document.createElement('div'); menu.className = 'menu';
        const rd = document.createElement('button'); rd.textContent = 'üîÅ Reset Daily'; rd.addEventListener('click', () => resetStudentDaily(currentClass, id)); menu.appendChild(rd);
        const rt = document.createElement('button'); rt.textContent = 'üßπ Reset Total'; rt.addEventListener('click', () => resetStudentTotal(currentClass, id)); menu.appendChild(rt);
        c.appendChild(menu); ctr.appendChild(c);
      });
      updateStats(students);
    }
    async function addPoint(className, studentId) { if (!isSignedIn()) return showToast("Sign in first.");
      const ref = doc(db, 'classes', className, 'students', studentId); let data;
      try { const s = await getDoc(ref); data = s.exists() ? s.data() : {}; const pts = data.points || { daily:0, total:0 }; await setDoc(ref, { ...data, points: { daily: pts.daily+1, total: pts.total+1 } }, { merge: true }); }
      catch (e) { console.error(e); showToast(`Couldn't add point for ${data?.name||studentId}.`, 'Retry', () => addPoint(className, studentId)); }
    }
    async function resetStudentDaily(className, studentId) { if (!isSignedIn()) return showToast("Sign in first."); const ref = doc(db, 'classes', className, 'students', studentId); let data;
      try { const s = await getDoc(ref); if (!s.exists()) return; data = s.data(); await setDoc(ref, { ...data, points: { daily:0, total:data.points.total } }, { merge: true }); }
      catch (e) { console.error(e); showToast(`Couldn't reset daily for ${data?.name||studentId}.`, 'Retry', () => resetStudentDaily(className, studentId)); }
    }
    async function resetStudentTotal(className, studentId) { if (!isSignedIn()) return showToast("Sign in first."); const ref = doc(db, 'classes', className, 'students', studentId); let data;
      try { const s = await getDoc(ref); if (!s.exists()) return; data = s.data(); await setDoc(ref, { ...data, points: { daily:data.points.daily, total:0 } }, { merge: true }); }
      catch (e) { console.error(e); showToast(`Couldn't reset total for ${data?.name||studentId}.`, 'Retry', () => resetStudentTotal(className, studentId)); }
    }
    async function resetDailyPoints() { if (!isSignedIn()) return showToast("Sign in first."); if (!currentClass) return showToast('Load a class first.'); if (!confirm(`Reset ALL daily for ${currentClass}?`)) return;
      try { const snaps = await getDocs(collection(db, 'classes', currentClass, 'students')); await Promise.all(snaps.docs.map(ds => setDoc(doc(db, 'classes', currentClass, 'students', ds.id), { ...ds.data(), points:{ daily:0, total:ds.data().points.total } }))); showToast('All daily points reset.'); }
      catch (e) { console.error(e); showToast("Couldn't reset all daily.", 'Retry', resetDailyPoints); }
    }
    async function resetTotalPoints() { if (!isSignedIn()) return showToast("Sign in first."); if (!currentClass) return showToast('Load a class first.'); if (!confirm(`Reset ALL total for ${currentClass}?`)) return;
      try { const snaps = await getDocs(collection(db, 'classes', currentClass, 'students')); await Promise.all(snaps.docs.map(ds => setDoc(doc(db, 'classes', currentClass, 'students', ds.id), { ...ds.data(), points:{ daily:ds.data().points.daily, total:0 } }))); showToast('All total points reset.'); }
      catch (e) { console.error(e); showToast("Couldn't reset all total.", 'Retry', resetTotalPoints); }
    }
    async function addDailyPointToAll() { if (!isSignedIn()) return showToast("Sign in first."); if (!currentClass) return showToast('Load a class first.'); if (!confirm(`+1 daily to ALL in ${currentClass}?`)) return;
      try { const snaps = await getDocs(collection(db, 'classes', currentClass, 'students')); await Promise.all(snaps.docs.map(ds => { const d = ds.data(), pts = d.points||{ daily:0, total:0 }; return setDoc(doc(db, 'classes', currentClass, 'students', ds.id), { ...d, points:{ daily: pts.daily+1, total: pts.total+1 } }, { merge: true }); })); showToast('+1 to all done.'); }
      catch (e) { console.error(e); showToast("Couldn't add to all.", 'Retry', addDailyPointToAll); }
    }
    // Expose globals
    window.toggleMenu = toggleMenu; window.addPoint = addPoint; window.resetStudentDaily = resetStudentDaily; window.resetStudentTotal = resetStudentTotal; window.resetDailyPoints = resetDailyPoints; window.resetTotalPoints = resetTotalPoints; window.addDailyPointToAll = addDailyPointToAll;
    // Initialize
    // populateClassDropdown(); // moved: runs after sign-in
  </script>
</body>
</html>
